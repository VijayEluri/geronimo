<?xml version="1.0" encoding="UTF-8"?>

<!-- $Rev$ $Date$ -->

<project default="bootstrap">
    
    <macrodef name="mvn">
        <attribute name="goal"/>
        <attribute name="dir" default="${basedir}"/>
        <sequential>
            <exec executable="mvn${platform.script.ext}" dir="@{dir}">
                <arg value="@{goal}"/>
            </exec>
        </sequential>
    </macrodef>
    
    <macrodef name="build-external">
        <attribute name="url"/>
        <attribute name="name"/>
        <sequential>
            <mkdir dir="${basedir}/target/external"/>
            
            <exec executable="svn" dir="${basedir}/target/external">
                <arg value="co"/>
                <arg value="@{url}"/>
                <arg value="@{name}"/>
            </exec>
            
            <mvn goal="install" dir="${basedir}/target/external/@{name}"/>
        </sequential>
    </macrodef>
    
    <macrodef name="build-stage">
        <attribute name="name"/>
        <sequential>
            <exec executable="mvn${platform.script.ext}" dir="${basedir}">
                <arg value="-Dstage=@{name}"/>
                <arg value="install"/>
            </exec>
        </sequential>
    </macrodef>
    
    <target name="init" depends="init:discover, init:windows, init:defaults">
        <record name="${basedir}/bootstrap.log"/>
        
        <echo>Starting bootstrap build...</echo>
    </target>
    
    <target name="init:discover">
        <condition property="isWindows">
            <os family="windows"/>
        </condition>
    </target>
    
    <target name="init:windows" if="isWindows">
        <property name="platform.script.ext" value=".bat"/>
    </target>
    
    <target name="init:defaults">
        <property name="platform.script.ext" value=""/>
    </target>
    
    
    <!-- ===== -->
    <!-- Steps -->
    <!-- ===== -->
    
    <target name="bootstrap" depends="clean, specs, modules, openejb2, assemble"/>
    
    <target name="modules" depends="init">
        <build-stage name="bootstrap"/>
    </target>
    
    <target name="assemble" depends="init">
        <build-stage name="assemble"/>
    </target>
    
    <target name="minimal" depends="init">
        <antcall target="clean">
            <param name="clean-minimal" value="true"/>
        </antcall>
        
        <mvn goal="install"/>
    </target>
    
    
    <!-- ======== -->
    <!-- Cleaning -->
    <!-- ======== -->
    
    <target name="clean" depends="clean:init, clean:minimal, clean:full">
        <delete dir="${basedir}/target"/>
        
        <mvn goal="clean"/>
    </target>
    
    <target name="clean:init" depends="init">
        <mkdir dir="${user.home}/.m2/repository"/>
    </target>
    
    <target name="clean:minimal" depends="clean:init" if="clean-minimal">
        <echo>Cleaning (minimal)...</echo>
        
        <delete>
            <fileset dir="${user.home}/.m2/repository">
                <include name="org/apache/geronimo/modules/**"/>
                <include name="org/apache/geronimo/configs/**"/>
                <include name="org/apache/geronimo/applications/**"/>
                <include name="org/apache/geronimo/assemblies/**"/>
                <include name="org/apache/geronimo/maven-plugins/**"/>
            </fileset>
        </delete>
    </target>
    
    <target name="clean:full" depends="clean:init" unless="clean-minimal">
        <echo>Cleaning (full)...</echo>
        
        <delete dir="${user.home}/.m2/repository"/>
    </target>
    
    
    <!-- ========= -->
    <!-- Externals -->
    <!-- ========= -->
    
    <target name="specs" depends="init">
        <echo>Building Specs...</echo>
        <build-external url="http://svn.apache.org/repos/asf/geronimo/specs/trunk" name="specs"/>
    </target>
    
    <target name="openejb2" depends="init">
        <echo>Building OpenEJB2...</echo>
        <build-external url="http://svn.codehaus.org/openejb/trunk/openejb2" name="openejb2"/>
    </target>

</project>
