<?xml version="1.0" encoding="UTF-8"?>

<!-- $Rev: 45928 $ $Date: 2004-09-11 17:03:39 -0700 (Sat, 11 Sep 2004) $ -->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:u="jelly:util"
    xmlns:ant="jelly:ant"
    xmlns:deploy="geronimo:deploy">

    <goal name="default" prereqs="ear"/>
    <goal name="build" prereqs="default"/>

    <goal name="rebuild" prereqs="clean,build"/>

    <goal name="ejb" prereqs="java:compile">
        <ant:jar destfile="target/${pom.artifactId}-ejb.jar">
            <fileset dir="target/classes">
                <exclude name="**/*Servlet.class"/>
                <exclude name="**/*Client.class"/>
            </fileset>
            <fileset dir="src/resources/ejb"/>
        </ant:jar>
    </goal>

    <goal name="client" prereqs="java:compile">
        <ant:jar destfile="target/${pom.artifactId}-client.jar">
            <fileset dir="target/classes">
                <include name="**/*Client.class"/>
                <include name="**/MagicGBall.class"/>
                <include name="**/MagicGBallHome.class"/>
                <include name="**/MagicGBallCallbackHandler.class"/>
            </fileset>
            <fileset dir="src/resources/client"/>
            <manifest>
                <attribute name="Main-Class" value="org.acme.MagicGBallClient"/>
            </manifest>
        </ant:jar>
    </goal>

    <goal name="ear" prereqs="ejb,war:war,client">
        <ant:jar destfile="target/${pom.artifactId}.ear">
            <fileset dir="target">
                <include name="${pom.artifactId}-ejb.jar"/>
                <include name="${pom.artifactId}-client.jar"/>
                <include name="${pom.artifactId}.war"/>
            </fileset>
            <fileset dir="src/resources/ear"/>
        </ant:jar>
    </goal>

    <goal name="site">
        <ant:mkdir dir="target/docs"/>
    </goal>

    <goal name="startServer" prereqs="ear">
        <j:set var="geronimo.server.corba.options" value="-Djavax.rmi.CORBA.UtilClass=org.openejb.corba.util.UtilDelegateImpl -Dorg.openejb.corba.UtilDelegateClass=com.sun.corba.se.internal.POA.ShutdownUtilDelegate -Dorg.omg.CORBA.ORBSingletonClass=com.sun.corba.se.internal.corba.ORBSingleton -Dorg.omg.CORBA.ORBClass=org.openejb.corba.sunorb.OpenEJBORB -Djavax.rmi.CORBA.PortableRemoteObjectClass=com.sun.corba.se.internal.javax.rmi.PortableRemoteObject"/>
        <deploy:unpackServer geronimoVersion="${geronimo_version}"/>
        <deploy:startRemoteServer
            geronimoTarget="${maven.build.dir}/geronimo-${geronimo_version}"
            vmArgs="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005 -Xmx512m -XX:MaxPermSize=128m ${geronimo.server.corba.options}"
            />
        <ant:echo message="Waiting for server at: ${maven.build.dir}/geronimo-${geronimo_version}"/>
        <u:sleep millis="60000"/>
        <deploy:waitForStarted
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            maxtries="125"
            id="org/apache/geronimo/RuntimeDeployer"/>
        <echo message="runtime deployer has started"/>
        <u:sleep millis="7000"/>
    </goal>
    <goal name="deployApp">
        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            module="${basedir}/target/magicGball.ear"
            plan="${basedir}/src/plan/magicgball-corba-plan.xml"/>

    </goal>

    

</project>
