<html>
    <head>
        <title>Documentation : Component Configuration</title>
	    <link rel="stylesheet" href="styles/site.css" type="text/css" />
        <META http-equiv="Content-Type" content="text/html; charset=UTF-8">	    
    </head>

    <body>
	    <table class="pagecontent" border="0" cellpadding="0" cellspacing="0" width="100%" bgcolor="#ffffff">
		    <tr>
			    <td valign="top" class="pagebody">
				    <div class="pageheader">
					    <span class="pagetitle">
                            Documentation : Component Configuration
                                                    </span>
				    </div>
				    <div class="pagesubheading">
					    This page last changed on Dec 14, 2005 by <font color="#0050B2">hcunico@gmail.com</font>.
				    </div>

				    <p><a name="ComponentConfiguration-top"></a><br/>
<em><b>Article donated by:</b> <a href="mailto:simon@godik.com" title="Send mail to Simon Godik">Simon Godik</a>, <a href="mailto:hcunico@gmail.com" title="Send mail to Hernan Cunico">Hernan Cunico</a></em></p>

<p>There are a number of components that need be configured for the system to work. Such components are: implementations of the <tt>ConfiguraitonEntryFactory</tt> interface, Login Modules, Login Module Use among others.</p>

<p>We start with GBeans that implement <tt>ConfigurationEntryFactory</tt> interface and supporting GBeans, followed by the <tt>LoginModule</tt> gbean.</p>

<h1><a name="ComponentConfiguration-ConfiguringDirectConfigurationEntry"></a>Configuring DirectConfigurationEntry</h1>
<p><tt>DirectConfigurationEntry</tt> exposes login module directly to JAAS clients. You have to specify Login Module here directly. To be able to login into Geronimo specify <tt>JaasLoginCoordinator</tt> login module.</p>

<p><tt>DirectConfigurationEntry</tt> GBean declares following metadata:</p>
<ul>
	<li><tt>applicationConfigName</tt> - attribute; application configuration name; this is a key by which configuration entry is found.</li>
	<li><tt>controlFlag</tt> - attribute; login module control flag according to the JAAS semantics; the only value that makes sense here is REQUIRED.</li>
	<li><tt>wrapPrincipals</tt> - attribute; possible values are true and false. If set to <b>true</b>, all Principals generated by the login module (<b>Login Domain</b>) will be wrapped into the <tt>DomainPrincipal</tt> and every <tt>DomainPrincipal</tt> will be wrapped into the <tt>RealmPrincipal</tt>. This enables J2EE role mappings into <tt>DomainPrincipals</tt> and <tt>RealmPrincipals</tt>.</li>
	<li><tt>Module</tt> - reference; This is object name specification for the  <tt>LoginModuleGBean</tt>.</li>
</ul>


<p>The following example shows how <tt>DirectConfigurationEntry</tt> is configured to use the <tt>ServerLoginCoordinator</tt> login module GBean.</p>

<div class="code" style="border-style: solid; "><div class="codeContent">
<pre class="code-xml">&lt;configuration
    xmlns=<span class="code-quote">"http://geronimo.apache.org/xml/ns/deployment"</span>
    parentId=<span class="code-quote">"org/apache/geronimo/Client"</span>
    configId=<span class="code-quote">"org/apache/geronimo/ClientSecurity"</span>
    &gt;
<span class="code-tag">&lt;GBean name=<span class="code-quote">"ServerLoginStubDCE"</span> class=<span class="code-quote">"org.apache.geronimo.security.jaas.DirectConfigurationEntry"</span>&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"applicationConfigName"</span>&gt;</span>server-login<span class="code-tag">&lt;/attribute&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"controlFlag"</span>&gt;</span>REQUIRED<span class="code-tag">&lt;/attribute&gt;</span>
        <span class="code-tag">&lt;reference name=<span class="code-quote">"Module"</span>&gt;</span>			<span class="code-tag"><span class="code-comment">&lt;!-- reference to the login module GBean: name=ServerLoginCoordinator --&gt;</span></span>
            <span class="code-tag">&lt;name&gt;</span>ServerLoginCoordinator<span class="code-tag">&lt;/name&gt;</span>
        <span class="code-tag">&lt;/reference&gt;</span>
<span class="code-tag">&lt;/GBean&gt;</span>

<span class="code-tag">&lt;GBean name=<span class="code-quote">"ServerLoginCoordinator"</span> class=<span class="code-quote">"org.apache.geronimo.security.jaas.LoginModuleGBean"</span>&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"loginModuleClass"</span>&gt;</span>org.apache.geronimo.security.jaas.client.JaasLoginCoordinator<span class="code-tag">&lt;/attribute&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"serverSide"</span>&gt;</span>false<span class="code-tag">&lt;/attribute&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"options"</span>&gt;</span>
            host=localhost				<span class="code-tag"><span class="code-comment">&lt;!-- Geronimo login service endpoint --&gt;</span></span>
            port=4242
            realm=geronimo-properties-realm		<span class="code-tag"><span class="code-comment">&lt;!-- Security realm name --&gt;</span></span>
        <span class="code-tag">&lt;/attribute&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"loginDomainName"</span>&gt;</span>geronimo-properties-realm<span class="code-tag">&lt;/attribute&gt;</span>
<span class="code-tag">&lt;/GBean&gt;</span>
<span class="code-tag">&lt;/configuration&gt;</span></pre>
</div></div>

<p><a href="#ComponentConfiguration-top" title="top on Component Configuration">Back to Top</a></p>

<h1><a name="ComponentConfiguration-ConfiguringServerRealmConfigurationEntry"></a>Configuring ServerRealmConfigurationEntry</h1>
<p><tt>ServerRealmConfigurationEntry</tt> connects server side component (such as a Servlet) to the <b>Security Realm</b>. It allows <b>decoupling</b> of configuration name and <b>Security Realm</b> name.</p>

<p><tt>ServerRealmConfigurationEntry</tt> declares following metadata:</p>
<ul>
	<li><tt>applicationConfigName</tt> - attribute; application configuration name; this is a key by which configuration entry is found.</li>
	<li><tt>realmName</tt> - attribute; security realm name.</li>
	<li><tt>LoginService</tt> - reference;  object name for the JAAS Login Service GBean.</li>
	<li><tt>wrapPrincipals</tt> - attribute; possible values are true and false. If set to <b>true</b>, all Principals generated by the login module (<b>Login Domain</b>) will be wrapped into the DomainPrincipal and every DomainPrincipal will be wrapped into the RealmPrincipal. This enables J2EE role mappings into DomainPrincipals and RealmPrincipals.</li>
</ul>


<p>The following example shows how to setup the <tt>ServerRealmConfigurationEntry</tt> with the name of JMX. The security realm name is <tt>geronimo-properties-realm</tt>.</p>

<div class="code" style="border-style: solid; "><div class="codeContent">
<pre class="code-xml">&lt;configuration
    xmlns=<span class="code-quote">"http://geronimo.apache.org/xml/ns/deployment-1.0"</span>
    configId=<span class="code-quote">"org/apache/geronimo/Security"</span>
    parentId=<span class="code-quote">"org/apache/geronimo/RMINaming"</span>
    &gt;

    <span class="code-tag">&lt;GBean name=<span class="code-quote">"JMX"</span> class=<span class="code-quote">"org.apache.geronimo.security.jaas.ServerRealmConfigurationEntry"</span>&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"applicationConfigName"</span>&gt;</span>JMX<span class="code-tag">&lt;/attribute&gt;</span>
        <span class="code-tag">&lt;attribute name=<span class="code-quote">"realmName"</span>&gt;</span>geronimo-properties-realm<span class="code-tag">&lt;/attribute&gt;</span>	<span class="code-tag"><span class="code-comment">&lt;!-- Security Realm name --&gt;</span></span>
        <span class="code-tag">&lt;reference name=<span class="code-quote">"LoginService"</span>&gt;</span>			         <span class="code-tag"><span class="code-comment">&lt;!--reference to the login service GBean --&gt;</span></span>
            <span class="code-tag">&lt;name&gt;</span>JaasLoginService<span class="code-tag">&lt;/name&gt;</span>
        <span class="code-tag">&lt;/reference&gt;</span>
    <span class="code-tag">&lt;/GBean&gt;</span>

<span class="code-tag">&lt;/configuration&gt;</span></pre>
</div></div>

<p><a href="#ComponentConfiguration-top" title="top on Component Configuration">Back to Top</a></p>

<h1><a name="ComponentConfiguration-ConfiguringSecurityRealm"></a>Configuring Security Realm</h1>
<p>The only implementation of the <tt>org.apache.geronimo.security.realm.SecurityRealm</tt> interface in Geronimo is the <tt>org.apache.geronimo.security.realm.GenericSecurityRealm</tt> class. </p>

<p><tt>org.apache.geronimo.security.realm.GenericSecurityRealm</tt> implements 2 interfaces: <tt>SecurityRealm</tt> and <tt>ConfigurationEntryFactory</tt>. The <tt>GenericSecurityRealm</tt> name is also the name of the <tt>ConfigurationEntryFactory</tt> implementation. That is why you can use <tt>GenericSecurityRealm</tt> name from your application as <b>application configuration entry name</b> passed to the <tt>LoginContext()</tt> constructor, see the <a href="Geronimo and JAAS.html" title="Geronimo and JAAS">Geronimo and JAAS</a> section.</p>

<p>You need to give a name to the <tt>GenericSecurityRealm</tt> and configure it's authentication policy by wiring up login modules into the realm. Login modules are not wired up by themselves but are <b>qualified by their use</b> in the computation of authentication outcome.</p>

<p>The list of login modules that must be configured into the <tt>GenericSecurityRealm</tt> is specified with the <tt>org.apache.geronimo.security.jaas.JaasLoginModuleUse</tt> GBean. It is injected with the <tt>LoginModuleGBean</tt>, the value of the control-flag that specifies how authentication outcome of this login module must be combined with the authentication outcomes of other login modules to compute authentication result, and a reference to the next <tt>LoginModuleUse</tt> definition.</p>

<p>You may wonder why do you need a linked list of GBeans. Wouldn't it be much easier to list parameters for the <tt>GenericSecurityRealm</tt> and be done with it?</p>

<p>The answer is that Geronimo is an <b>IOC container</b> and one of it's major functions in addition to dependency injection is dependency management. That means that if GBean A depends on GBean B, then GBean B will be started by the Geronimo container before GBean A. Login modules are deployed as GBeans and <tt>GenericSecurityRealm</tt> GBean depends on the login module GBeans. If you just list login module object names together with the control flags, Geronimo container would not be able to resolve this dependencies and you would not have a guarantee that all login modules wired up into the generic Security Realm are up and running before <tt>GenericSecurityRealm</tt> comes online.</p>

<p>But still, an effort required to configure login modules into <tt>GenericSecurityRealm</tt> with the list of <tt>LoginModuleUse</tt> GBeans may seem excessive. To help with this kind of problems GBean definition syntax allows for <em>syntactic sugar</em> in the form of <b>xml-reference</b> element. At this point it is necessary to emphasize that this is just a reference that gets processed at the deployment time to create and wire up all GBeans that otherwise would have been explicitly defined. We will show the use of <b>xml-reference</b> in the <tt>GenericSecurityRealm</tt> configuration later.</p>

<p>Here is an example of generic-security-realm setup, we want to wire the  <tt>GenericSecurityRealm</tt> named <b>geronimo-properties-realm</b> with the login module <br/>
named <b>properties-login</b>  that authenticates against a property file. Our <b>Security Realm</b> authentication policy requires <b>properties-login</b> module authentication to succeed.</p>

<div class="code" style="border-style: solid; "><div class="codeContent">
<pre class="code-xml"><span class="code-tag">&lt;GBean name=<span class="code-quote">"geronimo-properties-realm"</span> class=<span class="code-quote">"org.apache.geronimo.security.realm.GenericSecurityRealm"</span>&gt;</span>

   &lt;!-- security-realm name; this is a name of the Security Realm as well as the name of
     -- the configuration entry used by the application --&gt;

   <span class="code-tag">&lt;attribute name=<span class="code-quote">"realmName"</span>&gt;</span>geronimo-properties-realm<span class="code-tag">&lt;/attribute&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- reference to the head of the login module use list --&gt;</span></span>
   <span class="code-tag">&lt;reference name=<span class="code-quote">"LoginModuleConfiguration"</span>&gt;</span>
      <span class="code-tag">&lt;name&gt;</span>properties-login<span class="code-tag">&lt;/name&gt;</span>
   <span class="code-tag">&lt;/reference&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- server-info reference is passed to most GBeans --&gt;</span></span>
   <span class="code-tag">&lt;reference name=<span class="code-quote">"ServerInfo"</span>&gt;</span>
      <span class="code-tag">&lt;module&gt;</span>org/apache/geronimo/System<span class="code-tag">&lt;/module&gt;</span><span class="code-tag">&lt;name&gt;</span>ServerInfo<span class="code-tag">&lt;/name&gt;</span>
   <span class="code-tag">&lt;/reference&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- reference to the login-service GBean --&gt;</span></span>
   <span class="code-tag">&lt;reference name=<span class="code-quote">"LoginService"</span>&gt;</span><span class="code-tag">&lt;name&gt;</span>JaasLoginService<span class="code-tag">&lt;/name&gt;</span><span class="code-tag">&lt;/reference&gt;</span>
<span class="code-tag">&lt;/GBean&gt;</span>

<span class="code-tag"><span class="code-comment">&lt;!-- this is the head of the login-module-use list --&gt;</span></span>
<span class="code-tag">&lt;GBean name=<span class="code-quote">"properties-login"</span> class=<span class="code-quote">"org.apache.geronimo.security.jaas.JaasLoginModuleUse"</span>&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- login module must succeed --&gt;</span></span>
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"controlFlag"</span>&gt;</span>REQUIRED<span class="code-tag">&lt;/attribute&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- reference to the login module --&gt;</span></span>
   <span class="code-tag">&lt;reference name=<span class="code-quote">"LoginModule"</span>&gt;</span>
         <span class="code-tag">&lt;name&gt;</span>properties-login<span class="code-tag">&lt;/name&gt;</span>
   <span class="code-tag">&lt;/reference&gt;</span>
<span class="code-tag">&lt;/GBean&gt;</span>

<span class="code-tag"><span class="code-comment">&lt;!-- this is login module GBean --&gt;</span></span>
<span class="code-tag">&lt;GBean name=<span class="code-quote">"properties-login"</span> class=<span class="code-quote">"org.apache.geronimo.security.jaas.LoginModuleGBean"</span>&gt;</span>
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"loginModuleClass"</span>&gt;</span>
      org.apache.geronimo.security.realm.providers.PropertiesFileLoginModule
   <span class="code-tag">&lt;/attribute&gt;</span>
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"serverSide"</span>&gt;</span>true<span class="code-tag">&lt;/attribute&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- login module specific options --&gt;</span></span>
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"options"</span>&gt;</span>
      usersURI=var/security/users.properties	<span class="code-tag"><span class="code-comment">&lt;!-- user database --&gt;</span></span>
      groupsURI=var/security/groups.properties	<span class="code-tag"><span class="code-comment">&lt;!-- group database --&gt;</span></span>
   <span class="code-tag">&lt;/attribute&gt;</span>
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"loginDomainName"</span>&gt;</span>geronimo-properties<span class="code-tag">&lt;/attribute&gt;</span>
<span class="code-tag">&lt;/GBean&gt;</span></pre>
</div></div>

<p>It does not look too bad in this example but imagine that you have 2 login modules in the Security Realm and how many GBean dependencies you have to configure.</p>

<p>Note that the order in which all these elements are defined does not matter. If you look at the deployment plans, you will find that login-module GBeans are defined first (as they represent elements of reuse by the <tt>GenericSecurityRealm</tt> GBeans). <tt>GenericSecurityRealm</tt> GBeans and <tt>JaasLoginModuleUse</tt> GBeans are normally close to each other.</p>

<p><a href="#ComponentConfiguration-top" title="top on Component Configuration">Back to Top</a></p>

<h1><a name="ComponentConfiguration-ConfiguringGenericSecurityRealmusingxmlreference"></a>Configuring GenericSecurityRealm using xml-reference <a name="ComponentConfiguration-xmlreference"></a></h1>
<p>The reason for the introduction of the <b>xml-reference</b> element in GBean syntax was explained earlier. But just to repeat: it is a <em>syntactic sugar</em> that allows <b>problem friendly</b> xml syntax in GBean definition. </p>

<p><b>Problem-friendly</b> xml syntax for the login module configuration is defined by the "http://geronimo.apache.org/xml/ns/loginconfig-1.0" xml namespace.</p>

<p>The following example briefly shows how the <tt>LoginConfig</tt> schema is used.</p>

<div class="code" style="border-style: solid; "><div class="codeContent">
<pre class="code-xml">&lt;GBean name=<span class="code-quote">"geronimo-properties-realm"</span>
   class=<span class="code-quote">"org.apache.geronimo.security.realm.GenericSecurityRealm"</span>&gt;

   &lt;!-- security-realm name; this name is reused by the
     -- configuration-entry-factory interface implementation by the
     -- generic-security-realm; you may use this name as application
     -- configuration name parameter passed to the LoginContext constructor --&gt;

   <span class="code-tag">&lt;attribute name=<span class="code-quote">"realmName"</span>&gt;</span>geronimo-properties-realm<span class="code-tag">&lt;/attribute&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- xml reference, better than before? --&gt;</span></span>
   <span class="code-tag">&lt;xml-reference name=<span class="code-quote">"LoginModuleConfiguration"</span>&gt;</span>
      <span class="code-tag">&lt;lc:login-config <span class="code-keyword">xmlns:lc</span>=<span class="code-quote">"http://geronimo.apache.org/xml/ns/loginconfig"</span>&gt;</span>
         <span class="code-tag">&lt;lc:login-module control-flag=<span class="code-quote">"REQUIRED"</span> server-side=<span class="code-quote">"true"</span>&gt;</span>
            <span class="code-tag">&lt;lc:login-domain-name&gt;</span>client-properties-realm<span class="code-tag">&lt;/lc:login-domain-name&gt;</span>
            <span class="code-tag">&lt;lc:login-module-class&gt;</span>
                org.apache.geronimo.security.realm.providers.PropertiesFileLoginModule
            <span class="code-tag">&lt;/lc:login-module-class&gt;</span>
            <span class="code-tag">&lt;lc:option name=<span class="code-quote">"usersURI"</span>&gt;</span>
               var/security/users.properties
            <span class="code-tag">&lt;/lc:option&gt;</span>
            <span class="code-tag">&lt;lc:option name=<span class="code-quote">"groupsURI"</span>&gt;</span>
               var/security/groups.properties
            <span class="code-tag">&lt;/lc:option&gt;</span>
         <span class="code-tag">&lt;/lc:login-module&gt;</span>
      <span class="code-tag">&lt;/lc:login-config&gt;</span>
   <span class="code-tag">&lt;/xml-reference&gt;</span>
   <span class="code-tag"><span class="code-comment">&lt;!-- server-info reference is passed to most GBeans --&gt;</span></span>
   <span class="code-tag">&lt;reference name=<span class="code-quote">"ServerInfo"</span>&gt;</span>
      <span class="code-tag">&lt;module&gt;</span>org/apache/geronimo/System<span class="code-tag">&lt;/module&gt;</span><span class="code-tag">&lt;name&gt;</span>ServerInfo<span class="code-tag">&lt;/name&gt;</span>
   <span class="code-tag">&lt;/reference&gt;</span>

   <span class="code-tag"><span class="code-comment">&lt;!-- reference to the login-service GBean --&gt;</span></span>
   <span class="code-tag">&lt;reference name=<span class="code-quote">"LoginService"</span>&gt;</span><span class="code-tag">&lt;name&gt;</span>JaasLoginService<span class="code-tag">&lt;/name&gt;</span><span class="code-tag">&lt;/reference&gt;</span>
<span class="code-tag">&lt;/GBean&gt;</span></pre>
</div></div>

<p><a href="#ComponentConfiguration-top" title="top on Component Configuration">Back to Top</a></p>

<h1><a name="ComponentConfiguration-ConfiguringLoginmodule"></a>Configuring Login module</h1>
<p>Login module is configured with <tt>org.apache.geronimo.security.jaas.LoginModuleGBean</tt>. It takes <tt>loginModuleClass</tt> attribute that specifies the login module implementation class. Other interesting parameters are options and <tt>loginDomainName</tt>.</p>

<p>The following is an example of a login module that uses property files as authentication database. Values of property files are passed as options attribute.</p>

<div class="code" style="border-style: solid; "><div class="codeContent">
<pre class="code-xml">&lt;GBean name=<span class="code-quote">"properties-login"</span>
   class=<span class="code-quote">"org.apache.geronimo.security.jaas.LoginModuleGBean"</span>&gt;
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"loginModuleClass"</span>&gt;</span>
      org.apache.geronimo.security.realm.providers.PropertiesFileLoginModule
   <span class="code-tag">&lt;/attribute&gt;</span>
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"serverSide"</span>&gt;</span>true<span class="code-tag">&lt;/attribute&gt;</span>
   <span class="code-tag">&lt;attribute name=<span class="code-quote">"options"</span>&gt;</span>
            usersURI=var/security/users.properties
            groupsURI=var/security/groups.properties
    <span class="code-tag">&lt;/attribute&gt;</span>
    <span class="code-tag">&lt;attribute name=<span class="code-quote">"loginDomainName"</span>&gt;</span>geronimo-properties-realm<span class="code-tag">&lt;/attribute&gt;</span>
<span class="code-tag">&lt;/GBean&gt;</span></pre>
</div></div>

<p><a href="#ComponentConfiguration-top" title="top on Component Configuration">Back to Top</a></p>

				    
                    			    </td>
		    </tr>
	    </table>
	    <table border="0" cellpadding="0" cellspacing="0" width="100%">
			<tr>
				<td height="12" background="border/border_bottom.gif"><img src="border/spacer.gif" width="1" height="1" border="0"/></td>
			</tr>
		    <tr>
			    <td align="center"><font color="grey">Document generated by Confluence on Dec 15, 2005 19:14</font></td>
		    </tr>
	    </table>
    </body>
</html>