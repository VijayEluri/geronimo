<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id: maven.xml,v 1.1 2003/08/12 18:18:45 jdillon Exp $ -->

<project
  xmlns:j="jelly:core"
  xmlns:u="jelly:util"
  xmlns:ant="jelly:ant"
  xmlns:castor="castor">
  
  <!-- ===================== -->
  <!-- Module Initialization -->
  <!-- ===================== -->
  
  <ant:property file="${basedir}/../../etc/project.properties"/>
  
  
  <!-- ================================= -->
  <!-- Compile XML->Java Binding Sources -->
  <!-- ================================= -->
  
  <preGoal name="java:compile">
    <attainGoal name="castor:prepare-filesystem"/>
      
    <!-- this does not currently support -binding-file 
    <castor:generate schema="${basedir}/src/schema/twiddle-configuration.xsd"
                     package="org.apache.geronimo.twiddle.config"
                     marshal="false"
                     types="j2"/>
    -->
    
    <!-- The following is a hacked snippet of the castor plugin -->
    
    <j:set var="schema" value="${basedir}/src/schema/twiddle-configuration.xsd"/>
    <j:set var="fileVar" value="${schema}.filename"/>
    <j:set var="uptodateVar" value="${schema}.uptodate"/>
    <ant:basename property="${fileVar}" file="${schema}"/>
    <j:set var="filename" value="${pom.getContext().getVariable(fileVar)}"/>
    <j:set var="context" value="${pom.getPluginContext('maven-castor-plugin')}"/>
    <j:set var="log" value="${pom.getPluginContext('maven-castor-plugin').getVariable('maven.castor.tstamp')}"/>
    <j:set var="gen" value="${pom.getPluginContext('maven-castor-plugin').getVariable('maven.castor.dest')}"/>
    
    <ant:uptodate property="${uptodateVar}" targetfile="${log}/${filename}">
      <ant:srcfiles dir="${basedir}" includes="${schema}"/>
    </ant:uptodate>
    
    <j:set var="uptodate" value="${pom.getContext().getVariable(uptodateVar)}"/>
    
    <j:if test="${uptodate == null}">
    
    <ant:java className="org.exolab.castor.builder.SourceGenerator"
              failonerror="true">
      <ant:arg value="-i"/>
      <ant:arg value="${schema}"/>
      <ant:arg value="-binding-file"/>
      <ant:arg value="${basedir}/src/etc/twiddle-configuration-binding.xml"/>
      <ant:arg value="-package"/>
      <ant:arg value="org.apache.geronimo.twiddle.config"/>
      <ant:arg value="-types"/>
      <ant:arg value="j2"/>
      <ant:arg value="-nomarshall"/>
      <ant:arg value="-f"/>
      <ant:arg value="-dest"/>
      <ant:arg value="${gen}"/>
    </ant:java>
    
    <ant:touch file="${log}/${filename}"/>
    
    </j:if>
    
  </preGoal>

</project>