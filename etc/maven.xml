<?xml version="1.0" encoding="UTF-8"?>

<!-- $Revision: 1.14 $ $Date: 2003/09/01 16:46:34 $ -->

<project default="default"
  xmlns:j="jelly:core"
  xmlns:u="jelly:util"
  xmlns:ant="jelly:ant"
  xmlns:maven="jelly:maven"
  xmlns:define="jelly:define"
  xmlns:xdoclet="common:xdoclet">
  
  <!-- ================= -->
  <!-- Global Properties -->
  <!-- ================= -->
  
  <!-- Determine what the top-level project root is -->
  <j:set var="project.root" value="${pom.parentBasedir().getParentFile().getCanonicalFile()}"/>
  
  <!-- Load the global properties -->
  <ant:property file="${project.root}/etc/global.properties"/>
  
  
  <!-- ==================== -->
  <!-- Default Global Goals -->
  <!-- ==================== -->
  
  <goal name="default">
    <attainGoal name="jar:install"/>
  </goal>
  
  <goal name="build">
    <attainGoal name="default"/>
  </goal>
  
  <goal name="rebuild">
    <attainGoal name="clean"/>
    <attainGoal name="build"/>
  </goal>
  
  <!-- For testing -->
  <goal name="hello">
    <ant:echo>
      H E L L O
      ---------
      Module Name: ${pom.name}
    </ant:echo>
  </goal>
  
  <!-- Remove classes which depend on changed files, so they will rebuild. -->
  <preGoal name="java:compile">
    <j:if test="${sourcesPresent}">
      <ant:depend srcdir="${maven.compile.source}"
                  destdir="${maven.build.dest}"
                  dump="false"
                  closure="false">
        <j:forEach var="sm" items="${pom.build.sourceModifications}">
          <ant:available property="classPresent" classname="${sm.className}"/>
          <j:if test="${classPresent != 'true'}">
            <j:forEach var="exclude" items="${sm.excludes}">
              <ant:exclude name="${exclude}"/>
            </j:forEach>
            <j:forEach var="include" items="${sm.includes}">
              <ant:include name="${include}"/>
            </j:forEach>
          </j:if>
        </j:forEach>
      </ant:depend>
    </j:if>
  </preGoal>
  
  <!-- Remove the log files -->
  <goal name="clobber"
        description="Removes all (non-repository installed) build generated files">
        
    <!-- Let clean:clean do some work first -->
    <attainGoal name="clean:clean"/>
    
    <j:jelly xmlns="jelly:ant">
      <delete quiet="false" failonerror="false">
        <fileset dir="${basedir}">
          <include name="maven.log"/>
          <include name="velocity.log*"/>
          <include name="junit*.properties"/>
        </fileset>
      </delete>
    </j:jelly>
  
  </goal>
  
  <!-- Cleanse source files -->
  <goal name="cleanse-sources"
        description="Cleanse source files, removing tabs and translating CRLF -> LF">
        
    <j:scope xmlns="jelly:ant">
      
      <!-- Cleanse sources -->
      <j:set var="srcdir" value="${basedir}/src/java"/>
      <u:available file="">
      <fixcrlf srcdir="${srcdir}" eol="lf" eof="remove" tab="remove" tablength="4">
        <include name="**/*.java"/>
      </fixcrlf>
      <fixcrlf srcdir="${basedir}" eol="lf" eof="remove" tab="remove" tablength="2">
        <include name="**/*.xml"/>
        <include name="**/*.html"/>
      </fixcrlf>
      </u:available>
      
      <!-- Cleanse test sources -->
      <j:set var="srcdir" value="${basedir}/src/test"/>
      <u:available file="${srcdir}">
        <fixcrlf srcdir="${srcdir}" eol="lf" eof="remove" tab="remove" tablength="4">
          <include name="**/*.java"/>
          <include name="**/*.xml"/>
          <include name="**/*.html"/>
        </fixcrlf>
        <fixcrlf srcdir="${srcdir}" eol="lf" eof="remove" tab="remove" tablength="2">
          <include name="**/*.xml"/>
          <include name="**/*.html"/>
        </fixcrlf>
      </u:available>
      
      <!-- Cleanse xdocs -->
      <j:set var="srcdir" value="${basedir}/src/xdocs"/>
      <u:available file="${srcdir}">
        <fixcrlf srcdir="${srcdir}" eol="lf" eof="remove" tab="remove" tablength="2">
          <include name="**/*.xml"/>
          <include name="**/*.html"/>
        </fixcrlf>
      </u:available>
      
      <!-- Cleanse build files -->
      <fixcrlf srcdir="." eol="lf" tab="remove" eof="remove" tablength="2">
        <include name="project.xml"/>
        <include name="maven.xml"/>
      </fixcrlf>
      
      <!-- Cleanse scripts -->
      <j:set var="srcdir" value="${basedir}/src/bin"/>
      <u:available file="${srcdir}">
        <fixcrlf srcdir="${srcdir}" eol="lf" eof="remove" tab="remove" tablength="4">
          <include name="**/*"/>
        </fixcrlf>
      </u:available>
      
    </j:scope>
    
  </goal>
  
  <!-- =================== -->
  <!-- XDoclet Integration -->
  <!-- =================== -->
  
  <define:taglib uri="common:xdoclet">
    
    <define:tag name="jmxdoclet" xmlns="jelly:ant">
      <j:if test="${srcdir == null}">
        <fail>Missing required attribute: srcdir</fail>
      </j:if>
      <j:if test="${destdir == null}">
        <fail>Missing required attribute: destdir</fail>
      </j:if>
      
      <!-- Inlcude the generated sources in the Javac compile -->
      <j:if test="${appendSet != null}">
        <path id="xdoclet.jmx.compile.src.set" location="${destdir}"/>
        <maven:addPath id="${appendSet}" refid="xdoclet.jmx.compile.src.set"/>
      </j:if>
      
      <echo>Generating MBean interfaces...</echo>
      
      <!-- Load the jmxdoclet task -->
      <taskdef name="jmxdoclet" classname="xdoclet.modules.jmx.JMXDocletTask">
        <classpath>
          <path refid="maven.dependency.classpath"/>
        </classpath>
      </taskdef>
      
      <!-- Where sources will be generated -->
      <mkdir dir="${destdir}"/>
      
      <!-- Generate MBean interfaces -->
      <jmxdoclet destDir="${destdir}" verbose="false">
        
        <fileset dir="${srcdir}">
          <include name="**/*.java"/>
        </fileset>
        
        <mbeaninterface templateFile="${project.root}/etc/xdoclet/template/jmx/mbean.xdt"/>
      </jmxdoclet>
      
    </define:tag>
  </define:taglib>
  
  <goal name="xdoclet:jmxdoclet:compile">
    <xdoclet:jmxdoclet
      srcdir="${basedir}/src/java"
      destdir="${basedir}/target/xdoclet/jmx"
      appendSet="maven.compile.src.set"/>
  </goal>
  
  <goal name="xdoclet:jmxdoclet:test-compile">
    <xdoclet:jmxdoclet
      srcdir="${basedir}/src/test"
      destdir="${basedir}/target/test-xodclet/jmx"
      appendSet="maven.test.compile.src.set"/>
  </goal>
  
</project>