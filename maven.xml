<?xml version="1.0" encoding="UTF-8"?>

<!-- $Id: maven.xml,v 1.9 2003/08/14 12:37:50 jstrachan Exp $ -->

<project default="modules:build" 
         xmlns:j="jelly:core" 
         xmlns:ant="jelly:ant" 
         xmlns:maven="jelly:maven">
  
  <!-- ===================== -->
  <!-- Module Initialization -->
  <!-- ===================== -->
  
  <ant:property file="${basedir}/etc/project.properties"/>
  
  
  <preGoal name="xdoc:jelly-transform">
    <attainGoal name="html2xdoc"/>
    <attainGoal name="faq"/>
  </preGoal>
  
  
  <goal name="run" prereqs="set.classpath"
        description="Runs the Geronimo Server using the current build">
    <ant:java classname="org.apache.geronimo.Main" fork="yes">
      <ant:classpath refid="test.classpath"/>
    </ant:java>
  </goal>

  <goal name="set.classpath" prereqs="java:compile, test:compile"
        description="Sets up the classpath for running things">
    <ant:path id="test.classpath">
      <ant:pathelement path="target/test-classes"/>
      <ant:pathelement path="modules/core/src/conf/"/>
      <ant:pathelement path="${maven.build.dest}"/>
      <ant:path refid="maven.dependency.classpath"/>
    </ant:path>
  </goal>
  
  
  <!-- ======= -->
  <!-- Modules -->
  <!-- ======= -->
  
  <goal name="modules:reactor">
    <maven:reactor
        basedir="${basedir}/modules"
        includes="*/project.xml"
        excludes="xmlbeans/project.xml"
        banner="Executing (${goals}):"
        ignoreFailures="false"
        goals="${goals}"
    />
  </goal>
  
  <goal name="modules:build">
    <j:set var="goals" value="jar:install"/>
    <attainGoal name="modules:reactor"/>
  </goal>
   
  <goal name="modules:rebuild">
    <j:set var="goals" value="clean, jar:install"/>
    <attainGoal name="modules:reactor"/>
  </goal>
  
  <goal name="modules:site">
    <j:set var="goals" value="site"/>
    <attainGoal name="modules:reactor"/>
  </goal>
  
  <goal name="modules:javadoc">
    <j:set var="goals" value="javadoc"/>
    <attainGoal name="modules:reactor"/>
  </goal>
  
  <goal name="modules:clean">
    <j:set var="goals" value="clean"/>
    <attainGoal name="modules:reactor"/>
  </goal>
  
  <preGoal name="clean">
    <attainGoal name="modules:clean"/>
  </preGoal>
  
  <goal name="build">
    <attainGoal name="modules:build"/>
  </goal>
  
  <goal name="rebuild">
    <attainGoal name="modules:rebuild"/>
  </goal>
  
  <goal name="javadoc">
    <attainGoal name="modules:javadoc"/>
  </goal>
  
  
  
  <postGoal name="site">
    <maven:attainGoal name="modules:site"/>
    <maven:attainGoal name="modules:copy-site"/>
  </postGoal>
  
  
  <goal name="modules:copy-site" prereqs="modules:site"
  	description="copy the generated websites of all the modules into the root project">
  	
  	<!-- a dummy scope tag to change XML namespace to ant -->
  	<j:scope xmlns="jelly:ant">
  	
      <fileScanner var="scanner">
        <fileset dir="${basedir}/modules" includes="*/project.xml" excludes="xmlbeans/project.xml"/>
      </fileScanner>
    
      <j:forEach var="file" items="${scanner.iterator()}">
        <j:set var="name">${file.parentFile.name}</j:set>
        <j:set var="outDir">${basedir}/target/docs/modules/${name}</j:set>
      
        <echo>Copying module ${name} to ${outDir}</echo>
        <mkdir dir="${outDir}"/>
        <copy todir="${outDir}">
          <fileset dir="${basedir}/modules/${name}/target/docs"/>
   	    </copy>
      </j:forEach>
    </j:scope>
  </goal>
  
  <goal name="site:tocvs" prereqs="modules:copy-site"
  	description="Creates the entire website and copies it to the local CVS repository so that it can be checked in to update the Incubator site">
  	
  	<j:choose xmlns="jelly:ant">
  	  <j:when test="${empty(geronimo.cvs.docdir)}">
  	    <echo>You must define a variable called geronimo.cvs.docdir to copy documentation to CVS</echo>
  	  </j:when>
  	  <j:otherwise>
        <mkdir dir="${geronimo.cvs.docdir}"/>
        <copy todir="${geronimo.cvs.docdir}">
          <fileset dir="${basedir}/target/docs"/>
   	    </copy>
  	  </j:otherwise>
  	</j:choose>
  </goal>
</project>
