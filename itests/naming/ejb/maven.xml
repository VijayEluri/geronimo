<?xml version="1.0" encoding="UTF-8"?>
<!-- 
/*
 * Copyright 2001-2005 The Apache Software Foundation.
 * 
 * Licensed under the Apache License, Version 2.0 (the "License");
 * you may not use this file except in compliance with the License.
 * You may obtain a copy of the License at
 * 
 *      http://www.apache.org/licenses/LICENSE-2.0
 * 
 * Unless required by applicable law or agreed to in writing, software
 * distributed under the License is distributed on an "AS IS" BASIS,
 * WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
 * See the License for the specific language governing permissions and
 * limitations under the License.
 */
 -->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:ant="jelly:ant"
    xmlns:deploy="geronimo:deploy"
    >

    <goal name="default" prereqs="ejb:install"/>

    <postGoal name="ejb:install">
        <attainGoal name="itest"/>
    </postGoal>

    <preGoal name="itest:setup">
        <ant:delete dir="${maven.build.dir}/geronimo"/>
        <deploy:unpackServer
            geronimoVersion="${geronimo_version}"
            geronimoName="geronimo"
            targetDir="${maven.build.dir}/geronimo"/>
        <deploy:startRemoteServer
            geronimoTarget="${maven.build.dir}/geronimo"
            vmArgs="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005 -Xmx512m -XX:MaxPermSize=128m -Djava.rmi.server.RMIClassLoaderSpi=org.apache.geronimo.system.rmi.RMIClassLoaderSpiImpl"
            configs="org/apache/geronimo/RuntimeDeployer"/>
        <ant:echo message="Waiting for server at: ${geronimoTarget}"/>
        <deploy:waitForStarted
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/apache/geronimo/RuntimeDeployer"/>
        <echo message="server has started"/>
        <!-- just because the config started doesn't mean any of its gbeans started -->
        <sleep seconds="5"/>
        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            plan="${basedir}/src/plans/plan1.xml"
            module="${basedir}/target/geronimo-itests-naming-ejb-${pom.currentVersion}.jar"
            />
        <echo message="distributed jar"/>
        <deploy:start
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/apache/geronimo/itests/naming/Ejb"/>
    </preGoal>

    <preGoal name="itest:teardown">
        <deploy:stop
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/apache/geronimo/itests/naming/Ejb"/>
 <!--       <deploy:undeploy
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="org/apache/geronimo/itests/naming/Ejb"/>
-->        <echo message="undeployed war"/>
        <deploy:stopRemoteServer
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"/>
        <echo message="server has stopped"/>
    </preGoal>

</project>


