<?xml version="1.0" encoding="UTF-8"?>
<!--

    Copyright 2005 The Apache Software Foundation

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->

<!-- $Rev$ $Date$ -->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:ant="jelly:ant"
    xmlns:deploy="geronimo:deploy"
    xmlns:velocity="jelly:velocity"
    xmlns:u="jelly:util">

    <j:set var="instDir" value="${maven.build.dir}/geronimo-${geronimo_version}"/>
    <j:set var="webServicePort" value="8080"/>
    <j:set var="allABconfigurations" value="org/apache/geronimo/ActivitySupplier1.0.3 org/apache/geronimo/AirlineSupplier1.0.3 org/apache/geronimo/Adventure1.0.1 org/apache/geronimo/AdventureDataSource1.0.1 org/apache/geronimo/AdventureBuilderJMS org/apache/geronimo/Bank1.0.3 org/apache/geronimo/LodgingSupplier1.0.3 org/apache/geronimo/OPC1.0.3" />
    <j:set var="allSystemConfigurations" value="geronimo/j2ee-deployer/${geronimo_version}/car geronimo/webconsole-jetty/${geronimo_version}/car geronimo/directory/${geronimo_version}/car geronimo/ldap-realm/${geronimo_version}/car geronimo/online-deployer/${geronimo_version}/car geronimo/j2ee-system/${geronimo_version}/car geronimo/activemq/${geronimo_version}/car geronimo/j2ee-server/${geronimo_version}/car geronimo/jetty/${geronimo_version}/car geronimo/jetty-deployer/${geronimo_version}/car geronimo/geronimo-gbean-deployer/${geronimo_version}/car geronimo/rmi-naming/${geronimo_version}/car geronimo/system-database/${geronimo_version}/car geronimo/j2ee-security/${geronimo_version}/car geronimo/activemq-broker/${geronimo_version}/car geronimo/uddi-jetty/${geronimo_version}/car geronimo/javamail/${geronimo_version}/car" />
    
    <goal name="default" prereqs="clean">
        <attainGoal name="ab:unpackServer"/>
        <attainGoal name="ab:startForDeployment"/>
        <attainGoal name="ab:deploy"/>
        <attainGoal name="ab:start"/>
    </goal>

    <goal name="ab:unpackServer">
        <!-- TODO: Make geronimoArtifactId configurable -->
        <deploy:unpackServer
            geronimoVersion="${geronimo_version}"
            geronimoArtifactId="geronimo-jetty-j2ee"/>    

        <!-- Copy necessary javamail jars -->
        <ant:copy todir="${instDir}/repository/org.apache.geronimo.specs/jars">
            <ant:fileset dir="${maven.repo.local}/org.apache.geronimo.specs/jars">
                <ant:include name="geronimo-activation_1.0.2_spec-${geronimo_spec_activation_version}.jar"/>
                <ant:include name="geronimo-javamail_1.3.1_spec-${geronimo_spec_javamail_version}.jar"/>
            </ant:fileset>
        </ant:copy>
        <ant:copy todir="${instDir}/repository/geronimo/jars">
            <ant:fileset dir="${maven.repo.local}/geronimo/jars">
              <ant:include name="geronimo-javamail-transport-${geronimo_version}.jar" />
              <ant:include name="geronimo-mail-${geronimo_version}.jar" />
            </ant:fileset>
        </ant:copy>
    </goal>

    <goal name="ab:startForDeployment">
        <deploy:startRemoteServer
            geronimoTarget="${instDir}"
            configs="geronimo/j2ee-deployer/${geronimo_version}/car geronimo/j2ee-security/${geronimo_version}/car geronimo/jetty-deployer/${geronimo_version}/car"/>
        <ant:echo message="Waiting for server to start at: ${instDir}"/>
        <!-- TODO: No way to specify vv -->
        <!-- TODO: Empty id leads to Exception -->
        <!-- TODO: Use maven properties, e.g. 1.0-SNAPSHOT -->
        <deploy:waitForStarted
            uri="jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            maxTries="120"
            id="geronimo/j2ee-deployer/${geronimo_version}/car"/>
        <echo message="Deployer has started"/>
        <u:sleep millis="60000"/>    
    </goal>
    
    <goal name="ab:deploy" description="Deploys Adventure Builder">
        <ant:delete dir="${maven.build.dir}/plan" />

        <fileScanner var="plans">
            <fileset dir="${basedir}/src/plan">
                <include name="*-plan.xml"/>
            </fileset>
        </fileScanner>

        <ant:mkdir dir="${maven.build.dir}/plan"/>
        <j:forEach var="plan" items="${plans.iterator()}">
            <j:set var="planName" value="${plan.name}"/>
            <echo>Preprocessing ${planName}</echo>
            <velocity:merge
                basedir="${basedir}/src/plan"
                template="${planName}"
                name="${maven.build.dir}/plan/${planName}"/>
        </j:forEach>
        
        <ant:echo>Distributing JMS Configuration</ant:echo>
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${maven.repo.local}/activemq/rars/activemq-ra-${activemq_version}.rar"
            plan="${maven.build.dir}/plan/adventure1.0.3-jms-ra-plan.xml"/>

        <ant:echo>Distributing Database Configuration</ant:echo>
        <!-- TODO: TranQL version hardcoded -->
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${maven.repo.local}/tranql/rars/tranql-connector-derby-embed-xa-1.1-SNAPSHOT.rar"
            plan="${maven.build.dir}/plan/adventure1.0.1-db-ra-plan.xml"/>

        <ant:echo>Distributing Adventure Builder Consumer Website Application</ant:echo>
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${ab.home}/consumerwebsite.ear"
            plan="${maven.build.dir}/plan/consumerwebsite1.0.1.ear-plan.xml"/>

        <ant:echo>Distributing Adventure Builder Activity Supplier Application</ant:echo>
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${ab.home}/activitysupplier.ear"
            plan="${maven.build.dir}/plan/activitysupplier1.0.3.ear-plan.xml"/>

        <ant:echo>Distributing Adventure Builder OPC Application</ant:echo>
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${ab.home}/opc.ear"
            plan="${maven.build.dir}/plan/opc1.0.3.ear-plan.xml"/>

        <ant:echo>Distributing Adventure Builder Airline Supplier Application</ant:echo>
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${ab.home}/airlinesupplier.ear"
            plan="${maven.build.dir}/plan/airlinesupplier1.0.3.ear-plan.xml"/>

        <ant:echo>Distributing Adventure Builder Bank Application</ant:echo>
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${ab.home}/bank.ear"
            plan="${maven.build.dir}/plan/bank1.0.3.ear-plan.xml"/>

        <ant:echo>Distributing Adventure Lodging Supplier Application</ant:echo>
        <deploy:distribute
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            module="${ab.home}/lodgingsupplier.ear"
            plan="${maven.build.dir}/plan/lodgingsupplier1.0.3.ear-plan.xml"/>

        <ant:echo>Creating Adventure Builder Database Schema</ant:echo>
        <j:set var="derby.system.home" value="${instDir}/var/derby"/>
        <ant:sql driver="org.apache.derby.jdbc.EmbeddedDriver"
            url="jdbc:derby:${derby.system.home}/AdventureDB;create=true" userid="" password=""
            autocommit="true">
            <ant:fileset dir="src/sql"/>
            <ant:classpath>
                <ant:pathelement location="${maven.repo.local}/org.apache.derby/jars/derby-${derby_version}.jar"/>
            </ant:classpath>
        </ant:sql>
    </goal>

    <goal name="ab:start" description="Start Adventure Builder">
        <deploy:start
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            id="org/apache/geronimo/Adventure1.0.1"/>
        <deploy:start
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            id="org/apache/geronimo/AirlineSupplier1.0.3"/>
        <deploy:start
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            id="org/apache/geronimo/ActivitySupplier1.0.3"/>
        <deploy:start
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            id="org/apache/geronimo/Bank1.0.3"/>
        <deploy:start
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            id="org/apache/geronimo/LodgingSupplier1.0.3"/>
        <deploy:start
            uri="deployer:geronimo:jmx"
            username="system"
            password="manager"
            id="org/apache/geronimo/OPC1.0.3"/>
        <echo message="Adventure Builder has started"/>
    </goal>

    <goal name="ab:stop" description="Stop Adventure Builder">
        <deploy:stopRemoteServer
            uri="jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"/>
        <echo message="Adventure Builder has stopped"/>
    </goal>
</project>
