<?xml version="1.0" encoding="UTF-8"?>
<!--

    Copyright 2005 The Apache Software Foundation

    Licensed under the Apache License, Version 2.0 (the "License");
    you may not use this file except in compliance with the License.
    You may obtain a copy of the License at

       http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing, software
    distributed under the License is distributed on an "AS IS" BASIS,
    WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
    See the License for the specific language governing permissions and
    limitations under the License.
-->
<!-- $Rev$ $Date$ -->
<application xmlns="http://geronimo.apache.org/xml/ns/j2ee/application" 
    parentId="org/apache/geronimo/AdventureDataSource1.0.1"
    configId="org/apache/geronimo/ActivitySupplier1.0.3">
    <import>
        <uri>org/apache/geronimo/AdventureBuilderJMS</uri>
    </import>
    <module>
        <ejb>activitysupplier-ejb.jar</ejb>
        <openejb-jar xmlns="http://www.openejb.org/xml/ns/openejb-jar"
            xmlns:naming="http://geronimo.apache.org/xml/ns/naming" 
            xmlns:sys="http://geronimo.apache.org/xml/ns/deployment"
            configId="NOT_USED">
            <cmp-connection-factory>           
                <resource-link>AdventureDataSource</resource-link>
            </cmp-connection-factory>
            <enterprise-beans>
                <session>
                    <ejb-name>ActivityPOEndpointBean</ejb-name>
                    <jndi-name>ActivityPOEndpointBean</jndi-name>
                    <resource-ref>   
                        <ref-name>jms/activity/QueueConnectionFactory</ref-name>
                        <resource-link>AdventureBuilderConnectionFactory</resource-link>   
                    </resource-ref>
                    <resource-ref>   
                        <ref-name>jms/activity/ActivityQueue</ref-name>
                        <resource-link>jms/activity/ActivityQueue</resource-link>   
                    </resource-ref>
                    <web-service-address>http://localhost:${webServicePort}/webservice/ActivityPOService</web-service-address>     
                </session>
                <entity>
                    <ejb-name>ActivityPurchaseOrderBean</ejb-name>
                    <jndi-name>com.sun.j2ee.blueprints.activitysupplier.purchaseorder.ejb.ActivityPurchaseOrderLocalHome</jndi-name>
                    <table-name>ActivityPurchaseOrder</table-name>
                    <cmp-field-mapping>
                        <cmp-field-name>poId</cmp-field-name>
                        <table-column>poId</table-column>
                    </cmp-field-mapping>
                    <ejb-local-ref>
                        <ref-name>ejb/local/activitysupplier/ActivityDetails</ref-name>
                        <name>ActivityDetailsBean</name>
                    </ejb-local-ref>
                    <resource-ref>
                        <ref-name>jdbc/adventure/AdventureDB</ref-name>
                        <resource-link>AdventureDataSource</resource-link>
                    </resource-ref>
                </entity>
                <entity>
                    <ejb-name>ActivityDetailsBean</ejb-name>
                    <jndi-name>com.sun.j2ee.blueprints.activitysupplier.purchaseorder.ejb.ActivityDetailsLocalHome</jndi-name>
                    <table-name>ActivityDetails</table-name>
                    <cmp-field-mapping>
                        <cmp-field-name>activityId</cmp-field-name>
                        <table-column>activityId</table-column>
                    </cmp-field-mapping>
                    <cmp-field-mapping>
                        <cmp-field-name>startDate</cmp-field-name>
                        <table-column>startDate</table-column>
                    </cmp-field-mapping>
                    <cmp-field-mapping>
                        <cmp-field-name>endDate</cmp-field-name>
                        <table-column>endDate</table-column>
                    </cmp-field-mapping>
                    <cmp-field-mapping>
                        <cmp-field-name>headCount</cmp-field-name>
                        <table-column>headCount</table-column>
                    </cmp-field-mapping>   
                    <cmp-field-mapping>
                        <cmp-field-name>activityDetailsBean_upk</cmp-field-name>
                        <cmp-field-class>java.lang.Integer</cmp-field-class>
                        <table-column>ActivityDetailsBean_upk</table-column>
                        <sql-type>INTEGER</sql-type>
                        <type-converter>org.tranql.sql.typeconverter.SerializableConverter</type-converter>
                    </cmp-field-mapping>
                    <primkey-field>activityDetailsBean_upk</primkey-field>
		            <key-generator xmlns="http://www.openejb.org/xml/ns/pkgen">
                        <auto-increment-table>
                            <sql>INSERT INTO ActivityDetails (activityId) VALUES(null)</sql>
                            <return-type>java.lang.Integer</return-type>
                        </auto-increment-table>
                    </key-generator>
                    <resource-ref>
                        <ref-name>jdbc/adventure/AdventureDB</ref-name>
                        <resource-link>AdventureDataSource</resource-link>
                    </resource-ref>
                </entity>
                <message-driven>
                    <ejb-name>ActivityMessageEJB</ejb-name>
                    <resource-adapter>
                        <resource-link>Adventure Builder JMS Resources</resource-link>
                    </resource-adapter>             
                    <activation-config>
                        <activation-config-property>
                            <activation-config-property-name>destination</activation-config-property-name>
                            <activation-config-property-value>jms/activity/ActivityQueue</activation-config-property-value>
                        </activation-config-property>
                        <activation-config-property>
                            <activation-config-property-name>destinationType</activation-config-property-name>
                            <activation-config-property-value>javax.jms.Queue</activation-config-property-value>
                        </activation-config-property>
                    </activation-config>
                    <naming:service-ref>
                        <naming:service-ref-name>service/WebServiceBroker</naming:service-ref-name>
                        <naming:port>
                            <naming:port-name>BrokerServiceIntfPort</naming:port-name>
                            <naming:protocol>http</naming:protocol>
                            <naming:host>localhost</naming:host>
                            <naming:port>${webServicePort}</naming:port>
                            <naming:uri>/webservice/WebServiceBroker</naming:uri>
                        </naming:port>
                    </naming:service-ref>
                </message-driven>  
            </enterprise-beans>
            <relationships> 
                <ejb-relation>
                    <ejb-relation-name>ActivityRelations</ejb-relation-name>
                    <ejb-relationship-role>
                        <ejb-relationship-role-name>ActivityPurchaseOrderBean</ejb-relationship-role-name>
                        <relationship-role-source>
                            <ejb-name>ActivityPurchaseOrderBean</ejb-name>
                        </relationship-role-source>
                        <cmr-field>
                            <cmr-field-name>activities</cmr-field-name>
                        </cmr-field>
                        <role-mapping>
                            <cmr-field-mapping>
                                <key-column>poId</key-column>
                                <foreign-key-column>ActivityPurchaseOrderBean_activities</foreign-key-column>
                            </cmr-field-mapping>
                        </role-mapping>
                    </ejb-relationship-role>
                </ejb-relation>
            </relationships>
        </openejb-jar>
    </module>
</application>
