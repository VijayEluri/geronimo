<?xml version="1.0" encoding="UTF-8"?>

<!-- $Rev: 45928 $ $Date: 2004-09-11 17:03:39 -0700 (Sat, 11 Sep 2004) $ -->

<project default="default"
    xmlns:j="jelly:core"
    xmlns:u="jelly:util"
    xmlns:ant="jelly:ant"
    xmlns:velocity="jelly:velocity"
    xmlns:deploy="geronimo:deploy">

    <goal name="default" prereqs="ear"/>
    <goal name="build" prereqs="default"/>

    <goal name="rebuild" prereqs="clean,build"/>

    <goal name="filter">
        <fileScanner var="plans">
            <fileset dir="${basedir}/src/plan">
                <include name="*-plan.xml"/>
            </fileset>
        </fileScanner>

    </goal>

    <goal name="site">
        <ant:mkdir dir="target/docs"/>
    </goal>

    <goal name="initVars">
        <j:set var="geronimo.home" value="${maven.build.dir}/geronimo-${geronimo_version}"/>
    </goal>

    <goal name="unpackServer" prereqs="initVars">
        <deploy:unpackServer geronimoVersion="${geronimo_version}"/>
        <j:set var="derby.system.home" value="${geronimo.home}/var/derby"/>
        
        <!-- setup the lame system properties that derby needs -->
        <j:invokeStatic className="java.lang.System" method="setProperty">
            <j:arg type="java.lang.String" value="derby.system.home"/>
            <j:arg type="java.lang.String" value="${derby.system.home}"/>
        </j:invokeStatic>
        <j:invokeStatic className="java.lang.System" method="setProperty">
            <j:arg type="java.lang.String" value="derby.storage.fileSyncTransactionLog"/>
            <j:arg type="java.lang.String" value="true"/>
        </j:invokeStatic>
        <ant:sql driver="org.apache.derby.jdbc.EmbeddedDriver"
            url="jdbc:derby:tradedb;create=true"            
            userid="" password=""
            autocommit="true"
            onerror="abort"  
            delimiter=";">   
            <ant:fileset dir="src/sql"/>
            <ant:classpath>
                <ant:pathelement location="${maven.repo.local}/org.apache.derby/jars/derby-${derby_version}.jar"/>
            </ant:classpath>
        </ant:sql>
    </goal>

    <goal name="startServer" prereqs="initVars">

        <deploy:startRemoteServer
            geronimoTarget="${maven.build.dir}/geronimo-${geronimo_version}"
            vmArgs="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=n,address=5005 -Xmx512m ${geronimo.corba.options} ${geronimo.ssl.options}"
            />
        <ant:echo message="Waiting for server at: ${maven.build.dir}/geronimo-${geronimo_version}"/>
        <u:sleep millis="60000"/>
        <deploy:waitForStarted
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            maxtries="125"
            id="org/apache/geronimo/JettyDeployer"/>
        <echo message="runtime deployer has started"/>
        <u:sleep millis="7000"/>
    </goal>
    <goal name="deployDaytrader">
        <deploy:distribute
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            module="${maven.repo.local}/daytrader/ears/daytrader-ear-${geronimo_version}.ear"
            plan="${basedir}/src/plan/daytrader-plan.xml"/>
    </goal>
    <goal name="startDaytrader">
        <deploy:start
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="${pom.groupId}/cars/${pom.artifactId}-${pom.currentVersion}.car"/>
    </goal>
    <goal name="stopDaytrader">
        <deploy:stop
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="${pom.groupId}/cars/${pom.artifactId}-${pom.currentVersion}.car"/>
    </goal>
    <goal name="undeployDaytrader">
        <deploy:undeploy
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"
            id="${pom.groupId}/cars/${pom.artifactId}-${pom.currentVersion}.car"/>
    </goal>
    <goal name="stopServer">  
        <deploy:stopRemoteServer
            uri="deployer:geronimo:jmx:rmi://localhost/jndi/rmi:/JMXConnector"
            username="system"
            password="manager"/>
    </goal>

    <goal name="runClient" prereqs="initVars">
        <j:if test="${context.getVariable('enable.debug') == 'true'}">
            <j:set var="geronimo.client.debug.options" value="-Xdebug -Xnoagent -Djava.compiler=NONE -Xrunjdwp:transport=dt_socket,server=y,suspend=y,address=5003"/>
        </j:if>
        <java classname="org.apache.geronimo.system.main.ClientCommandLine" fork="yes"
            jvmargs="${geronimo.client.debug.options} ${geronimo.corba.options} ${geronimo.ssl.options}">
            <classpath>
                <pathelement location="${maven.build.dir}/geronimo-${geronimo_version}/bin/client.jar"/>
            </classpath>
            <!--            <jvmarg value="${geronimo.server.corba.options}"/>-->
            <arg value="daytrader/cars/daytrader-derby-1.0-SNAPSHOT.car/tradeStreamerAppclient"/>
            <arg value="foo"/>
            <arg value="bar"/>
        </java>
    </goal>

</project>
